{% extends 'base.html' %}

{% block title %}Discussion - Matchify{% endblock %}

{% load static %}

{% block head %}
<style>
/* subtle green glow matching home page green (Tailwind green-500) */
.glow-green {
    text-shadow: 0 0 8px rgba(34,197,94,0.45), 0 0 18px rgba(34,197,94,0.12);
}
/* Animated gold medal icon used in the Leaderboard button */
.medal {
    display: inline-block;
    transform-origin: center;
    animation: float 2s ease-in-out infinite;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.35));
}
.medal.delay {
    animation-delay: 0.12s;
}
@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
}
.leaderboard-btn:focus { outline: 2px solid rgba(59,130,246,0.35); outline-offset: 2px; }
</style>
{% endblock %}

{# AJAX interceptor script moved to the bottom scripts block so it loads correctly. #}
{% block content %}
<div class="max-w-4xl mx-auto py-12">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold mb-0 text-green-500 glow-green">Community Discussion</h1>
                <a href="#" class="leaderboard-btn ml-4 inline-flex items-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-transform transform-gpu hover:scale-105" role="button" aria-label="Leaderboard">
                    <!-- left gold medal -->
                    <svg aria-hidden="true" class="w-5 h-5 medal mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="g1" x1="0" x2="1">
                                <stop offset="0" stop-color="#FFD54A" />
                                <stop offset="1" stop-color="#FFC107" />
                            </linearGradient>
                        </defs>
                        <circle cx="12" cy="8" r="4" fill="url(#g1)" />
                        <path d="M12 6.2l0.9 1.8L14.8 8l-1.5 1.1L13.6 11 12 10l-1.6 1-0.3-1.9L8.7 8l1.9-0.0L12 6.2z" fill="#E6A800" opacity="0.95" />
                        <path d="M8 14l-1.5 4 5-2 5 2L16 14" stroke="#D39E00" stroke-width="0.8" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span>Leaderboard</span>
                    <!-- right gold medal -->
                    <svg aria-hidden="true" class="w-5 h-5 medal delay ml-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="g2" x1="0" x2="1">
                                <stop offset="0" stop-color="#FFD54A" />
                                <stop offset="1" stop-color="#FFC107" />
                            </linearGradient>
                        </defs>
                        <circle cx="12" cy="8" r="4" fill="url(#g2)" />
                        <path d="M12 6.2l0.9 1.8L14.8 8l-1.5 1.1L13.6 11 12 10l-1.6 1-0.3-1.9L8.7 8l1.9-0.0L12 6.2z" fill="#E6A800" opacity="0.95" />
                        <path d="M8 14l-1.5 4 5-2 5 2L16 14" stroke="#D39E00" stroke-width="0.8" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </a>
            </div>

    <div class="glass border border-gray-700 rounded-2xl p-6 mb-6">
        <h2 class="text-xl font-semibold mb-3 text-purple-300">Create a Post</h2>
        <form id="post-form" method="post" enctype="multipart/form-data" class="space-y-3">
            {% csrf_token %}
            <div>{{ form.content }}</div>
            <div class="flex items-center gap-3">
                <label for="post-image-input" class="cursor-pointer text-blue-400 hover:text-blue-300">📄 Add image</label>
                <div id="selected-file-name" class="text-sm text-gray-300">No file chosen</div>
                <button class="ml-auto btn btn-emerald px-4 py-2">Post</button>
            </div>
            {{ form.image }}
        </form>
    </div>

    <!-- Filter controls: placed right below Create a Post and above the posts list (moved to left) -->
    <div class="max-w-4xl mx-auto mb-4 flex items-center">
        <div class="flex items-center space-x-3">
            <button class="px-4 py-2 bg-gray-800 text-white rounded-md font-medium border border-gray-700">Filter</button>

            <div class="relative" id="filter-dropdown">
                <button id="filter-toggle" aria-haspopup="true" aria-expanded="false" class="text-blue-500 hover:text-blue-600 focus:outline-none flex items-center" aria-label="Sort options">
                    <!-- filter icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 5h18v2H3V5zm4 6h10v2H7v-2zm6 6v2H7v-2h6z"/>
                    </svg>
                </button>

                <!-- dropdown is click/toggle controlled for accessibility and touch devices -->
                <div id="filter-menu" class="absolute left-0 mt-2 w-56 bg-gray-900 text-white rounded-lg shadow-lg hidden z-50" role="menu" aria-labelledby="filter-toggle">
                    <div class="px-4 py-2 text-sm font-semibold border-b border-gray-800">Sort By:</div>
                    <ul class="text-sm" role="none">
                        <li role="none"><a role="menuitem" href="?sort=newest" class="block px-4 py-2 hover:bg-gray-800">Newest to Oldest</a></li>
                        <li role="none"><a role="menuitem" href="?sort=oldest" class="block px-4 py-2 hover:bg-gray-800">Oldest to Newest</a></li>
                        <li role="none"><a role="menuitem" href="?sort=most_liked" class="block px-4 py-2 hover:bg-gray-800">Most Liked</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="space-y-4">
        {% for item in posts %}
            {% with post=item.post image_exists=item.image_exists likes=item.likes dislikes=item.dislikes user_reaction=item.user_reaction comments=item.comments %}
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-3">
                        {% if author_avatar_url %}
                            <img src="{{ author_avatar_url }}" alt="{{ post.author.username }} avatar" class="w-8 h-8 rounded-full object-cover" onerror="this.style.display='none'" />
                        {% else %}
                            <!-- try static avatar at /static/avatars/<username>.png, otherwise show initial -->
                            <img src="{% static 'avatars/' %}{{ post.author.username }}.png" alt="{{ post.author.username }} avatar" class="w-8 h-8 rounded-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'" onload="this.nextElementSibling.style.display='none'" />
                            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-sm text-white" style="display:none">{{ post.author.username|slice:":1"|upper }}</div>
                        {% endif %}
                        <a href="{% url 'profile' post.author.username %}" class="font-semibold text-blue-500">{{ post.author.username }}</a>
                    </div>
                    <div class="text-xs text-gray-400">{{ post.created_at }}</div>
                </div>
                <div class="text-gray-200">{{ post.content|linebreaksbr }}</div>
                {% if post.image and image_exists %}
                    <div class="mt-3">
                        <a href="{{ post.image.url }}" target="_blank" rel="noopener noreferrer">
                            <img src="{{ post.image.url }}" alt="Post image" class="w-full rounded-lg shadow-md mx-auto object-contain max-h-96">
                        </a>
                    </div>
                {% elif post.image and not image_exists %}
                    <div class="mt-3 text-sm text-gray-400 italic">Image not available</div>
                {% endif %}
                <!-- Reaction buttons -->
                <div class="mt-3 flex items-center space-x-4">
                    <form action="{% url 'react' post.id %}" method="post" class="inline-flex items-center">
                        {% csrf_token %}
                        <input type="hidden" name="value" value="1" />
                        <button type="submit" title="Like" class="flex items-center space-x-2 text-blue-500 hover:brightness-110">
                            <!-- Thumbs up -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5 fill-current" aria-hidden="true">
                                <path d="M2 21h4V9H2v12zM22 10c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L13.17 2 7.59 7.59C7.22 7.95 7 8.45 7 9v9c0 1.1.9 2 2 2h7c.82 0 1.54-.5 1.84-1.22L22 10z"/>
                            </svg>
                            <span class="text-sm text-blue-500">{{ likes }}</span>
                        </button>
                    </form>

                    <form action="{% url 'react' post.id %}" method="post" class="inline-flex items-center">
                        {% csrf_token %}
                        <input type="hidden" name="value" value="-1" />
                        <button type="submit" title="Dislike" class="flex items-center space-x-2 text-blue-500 hover:brightness-110">
                            <!-- Thumbs up rotated 180deg to act as thumbs down -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5 fill-current transform rotate-180" aria-hidden="true">
                                <path d="M2 21h4V9H2v12zM22 10c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L13.17 2 7.59 7.59C7.22 7.95 7 8.45 7 9v9c0 1.1.9 2 2 2h7c.82 0 1.54-.5 1.84-1.22L22 10z"/>
                            </svg>
                            <span class="text-sm text-blue-500">{{ dislikes }}</span>
                        </button>
                    </form>
                </div>

                <!-- Comments list -->
                <div class="mt-4 space-y-3">
                    {% for c in comments %}
                        {% with comment=c.comment likes=c.likes dislikes=c.dislikes user_reaction=c.user_reaction %}
                        <div id="comment-{{ comment.id }}" class="bg-gray-900 p-3 rounded">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        {% if c.avatar_url %}
                                            <img src="{{ c.avatar_url }}" alt="{{ comment.author.username }} avatar" class="w-6 h-6 rounded-full object-cover" onerror="this.style.display='none'" />
                                        {% else %}
                                            <img src="{% static 'avatars/' %}{{ comment.author.username }}.png" alt="{{ comment.author.username }} avatar" class="w-6 h-6 rounded-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'" onload="this.nextElementSibling.style.display='none'" />
                                            <div class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs text-white" style="display:none">{{ comment.author.username|slice:":1"|upper }}</div>
                                        {% endif %}
                                        <div class="text-sm text-blue-400 font-semibold"><a href="{% url 'profile' comment.author.username %}">{{ comment.author.username }}</a> <span class="text-xs text-gray-400">· {{ comment.created_at }}</span></div>
                                    </div>
                                    <div class="text-gray-200 text-sm mt-1">{{ comment.content|linebreaksbr }}</div>
                                </div>
                                <div class="ml-4 flex flex-col items-center space-y-2">
                                    <form action="{% url 'react' post.id %}" method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="comment_id" value="{{ comment.id }}" />
                                        <input type="hidden" name="value" value="1" />
                                        <button type="submit" title="Like comment" class="flex items-center space-x-1 text-blue-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-4 h-4 fill-current" aria-hidden="true"><path d="M2 21h4V9H2v12zM22 10c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L13.17 2 7.59 7.59C7.22 7.95 7 8.45 7 9v9c0 1.1.9 2 2 2h7c.82 0 1.54-.5 1.84-1.22L22 10z"/></svg>
                                            <span class="text-xs text-blue-500">{{ likes }}</span>
                                        </button>
                                    </form>
                                    <form action="{% url 'react' post.id %}" method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="comment_id" value="{{ comment.id }}" />
                                        <input type="hidden" name="value" value="-1" />
                                        <button type="submit" title="Dislike comment" class="flex items-center space-x-1 text-blue-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-4 h-4 fill-current transform rotate-180" aria-hidden="true"><path d="M2 21h4V9H2v12zM22 10c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L13.17 2 7.59 7.59C7.22 7.95 7 8.45 7 9v9c0 1.1.9 2 2 2h7c.82 0 1.54-.5 1.84-1.22L22 10z"/></svg>
                                            <span class="text-xs text-blue-500">{{ dislikes }}</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                    {% empty %}
                        <!-- no comments -->
                    {% endfor %}
                </div>

                <!-- Comment form -->
                <div class="mt-3">
                    <form action="{% url 'add_comment' post.id %}" method="post" class="flex items-start space-x-3">
                        {% csrf_token %}
                        <textarea name="content" rows="2" placeholder="Write a comment..." class="w-full p-2 rounded bg-gray-900 text-white placeholder-gray-400 text-sm"></textarea>
                        <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded">Reply</button>
                    </form>
                </div>
            </div>
            {% endwith %}
        {% empty %}
            <p class="text-center text-gray-400">No posts yet — be the first to share!</p>
        {% endfor %}
    </div>
</div>

<a href="{% url 'home' %}" class="fixed bottom-6 left-1/2 -translate-x-1/2 btn btn-purple px-10 py-3 shadow">
    ← Back to Home
</a>

    <!-- Show selected filename for file input -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fileInput = document.getElementById('post-image-input');
            const filenameDisplay = document.getElementById('selected-file-name');
            if (fileInput && filenameDisplay) {
                fileInput.addEventListener('change', function () {
                    const file = fileInput.files[0];
                    filenameDisplay.textContent = file ? file.name : 'No file chosen';
                });
            }
        });
    </script>

    <!-- Leaderboard modal -->
    <div id="leaderboard-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-60">
        <div class="bg-gray-900 rounded-lg p-6 w-full max-w-xl mx-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">School Leaderboard</h2>
                <button id="leaderboard-close" class="text-gray-300 hover:text-white">✕</button>
            </div>
            <div>
                <label for="leaderboard-search" class="sr-only">Search artist</label>
                <input id="leaderboard-search" type="search" placeholder="Search artist..." class="w-full p-3 rounded bg-gray-800 text-white" autocomplete="off" />
                <div id="leaderboard-suggestions" class="mt-2 bg-gray-800 rounded max-h-48 overflow-auto hidden"></div>
            </div>
            <div id="leaderboard-results" class="mt-4 text-sm text-gray-200">
                <!-- results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Smooth-scroll to comment anchor if present in URL after redirect
        document.addEventListener('DOMContentLoaded', function () {
            if (window.location.hash) {
                const el = document.querySelector(window.location.hash);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Optionally add a brief highlight
                    el.classList.add('ring', 'ring-green-400');
                    setTimeout(() => el.classList.remove('ring', 'ring-green-400'), 1800);
                }
            }
        });
    </script>

{% endblock %}

{% block scripts %}
<script>
(() => {
    // Attach handlers immediately if DOM already loaded, otherwise wait for DOMContentLoaded.
    const attach = () => {
        console.log('[discussion] attaching delegated submit handler');
        // Use event delegation: listen for submit events on the document and intercept
        // those whose form action contains '/react/'. This is robust to timing/order.
        document.addEventListener('submit', function(e){
            try {
                const form = e.target && (e.target.nodeName === 'FORM' ? e.target : e.target.closest('form'));
                if (!form) return;
                const action = form.getAttribute('action') || '';
                if (action.indexOf('/react/') === -1) return; // not a reaction form

                e.preventDefault();
                const url = action;
                const formData = new FormData(form);

                const csrfEl = form.querySelector('[name=csrfmiddlewaretoken]');
                const csrf = csrfEl ? csrfEl.value : '';

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrf
                    },
                    body: formData
                }).then(r => r.text().then(t => {
                    try { return JSON.parse(t); } catch (e) { console.error('[discussion] non-json response', t); return null; }
                })).then(data => {
                    if (data && data.success) {
                        // If this was a comment reaction, prefer updating the specific comment container
                        const commentInput = form.querySelector('input[name="comment_id"]');
                        if (commentInput) {
                            const cid = commentInput.value;
                            const commentEl = document.getElementById('comment-' + cid);
                            if (commentEl) {
                                const spans = commentEl.querySelectorAll('button > span');
                                if (spans.length > 0) {
                                    if (data.likes !== undefined && spans[0]) spans[0].textContent = data.likes;
                                    if (data.dislikes !== undefined && spans[1]) spans[1].textContent = data.dislikes;
                                }
                            }
                        } else {
                            // Post-level reaction: update the surrounding post container
                            const postContainer = form.closest('.bg-gray-800, .bg-gray-900');
                            if (postContainer) {
                                const spans = postContainer.querySelectorAll('button > span');
                                if (spans.length > 0) {
                                    if (data.likes !== undefined && spans[0]) spans[0].textContent = data.likes;
                                    if (data.dislikes !== undefined && spans[1]) spans[1].textContent = data.dislikes;
                                }
                            } else {
                                const likesSpan = form.querySelector('span');
                                if (likesSpan && data.likes !== undefined) likesSpan.textContent = data.likes;
                            }
                        }
                    }
                }).catch(err => console.error('[discussion] fetch error', err));

            } catch (err) {
                console.error('[discussion] submit handler error', err);
            }
        }, true);
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attach);
    } else {
        attach();
    }
})();
</script>
<script>
// Leaderboard modal behavior and autocomplete
document.addEventListener('DOMContentLoaded', function () {
    const toggle = document.querySelector('.leaderboard-btn');
    const modal = document.getElementById('leaderboard-modal');
    const closeBtn = document.getElementById('leaderboard-close');
    const search = document.getElementById('leaderboard-search');
    const suggestions = document.getElementById('leaderboard-suggestions');
    const results = document.getElementById('leaderboard-results');

    if (!toggle || !modal) return;

    const openModal = () => { modal.classList.remove('hidden'); modal.classList.add('flex'); search.focus(); };
    const closeModal = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); suggestions.classList.add('hidden'); results.innerHTML = ''; search.value = ''; };

    toggle.addEventListener('click', function (e) { e.preventDefault(); openModal(); });
    closeBtn.addEventListener('click', function (e) { e.preventDefault(); closeModal(); });
    modal.addEventListener('click', function (e) { if (e.target === modal) closeModal(); });

    // debounce helper
    const debounce = (fn, wait) => {
        let t;
        return function (...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); };
    };

    const doAutocomplete = debounce(function () {
        const q = search.value.trim();
        if (!q) { suggestions.classList.add('hidden'); return; }
        fetch(`/leaderboard/autocomplete?q=${encodeURIComponent(q)}`)
            .then(r => r.json())
            .then(data => {
                suggestions.innerHTML = '';
                if (!data.results || data.results.length === 0) { suggestions.classList.add('hidden'); return; }
                data.results.forEach(a => {
                    const el = document.createElement('div');
                    el.className = 'px-3 py-2 hover:bg-gray-700 cursor-pointer';
                    el.textContent = a.name;
                    el.dataset.artistId = a.id || '';
                    el.addEventListener('click', function () {
                        // Navigate to standalone leaderboard page for this artist
                        const url = '/leaderboard?artist_id=' + encodeURIComponent(a.id || '') + '&artist_name=' + encodeURIComponent(a.name || '');
                        window.location.href = url;
                    });
                    suggestions.appendChild(el);
                });
                suggestions.classList.remove('hidden');
            }).catch(e => { suggestions.classList.add('hidden'); });
    }, 250);

    search.addEventListener('input', doAutocomplete);
    search.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const name = search.value.trim();
            if (!name) return;
            const url = '/leaderboard?artist_name=' + encodeURIComponent(name);
            window.location.href = url;
        }
    });

    function fetchResults(artistId, artistName) {
        results.innerHTML = '<div class="text-gray-400">Loading...</div>';
        const params = new URLSearchParams();
        if (artistId) params.set('artist_id', artistId);
        if (artistName) params.set('artist_name', artistName);
        fetch('/leaderboard/results?' + params.toString())
            .then(r => r.json())
            .then(data => {
                if (!data.results || data.results.length === 0) {
                    results.innerHTML = '<div class="text-gray-400">No listeners found in your school.</div>';
                    return;
                }
                const rows = data.results.map((u, i) => `<div class="flex items-center justify-between py-2 border-b border-gray-800"><div class="font-semibold">${i+1}. ${u.username}</div><div class="text-gray-400">Score: ${u.score}</div></div>`).join('');
                results.innerHTML = `<div class="text-sm">Top listeners for "${artistName || ''}"</div><div class="mt-2 rounded bg-gray-800">${rows}</div>`;
            }).catch(e => { results.innerHTML = '<div class="text-red-400">Error loading results</div>'; });
    }
});
</script>
<script>
// Dropdown toggle for the filter menu: click to open, click outside or Esc to close,
// and basic keyboard support (ArrowDown opens and focuses first item).
document.addEventListener('DOMContentLoaded', function () {
    const toggle = document.getElementById('filter-toggle');
    const menu = document.getElementById('filter-menu');
    if (!toggle || !menu) return;

    const openMenu = () => {
        menu.classList.remove('hidden');
        toggle.setAttribute('aria-expanded', 'true');
    };
    const closeMenu = () => {
        menu.classList.add('hidden');
        toggle.setAttribute('aria-expanded', 'false');
    };

    toggle.addEventListener('click', function (e) {
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        if (expanded) closeMenu(); else openMenu();
    });

    // Close when clicking outside
    document.addEventListener('click', function (e) {
        if (!menu.contains(e.target) && !toggle.contains(e.target)) {
            closeMenu();
        }
    });

    // Keyboard handling
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeMenu();
            toggle.focus();
        }
        if ((e.key === 'ArrowDown' || e.key === 'Down') && document.activeElement === toggle) {
            // open and focus first item
            e.preventDefault();
            openMenu();
            const first = menu.querySelector('[role="menuitem"]');
            if (first && typeof first.focus === 'function') first.focus();
        }
    });
});
</script>
{% endblock %}
