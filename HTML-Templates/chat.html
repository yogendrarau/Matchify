<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chat with {{ friend.username }} - Matchify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    {% block head %}{% endblock %}
</head>
<body class="bg-app text-white min-h-screen flex flex-col">
    <!-- Header -->
    <header class="glass fixed w-full top-0 z-10 border-b border-gray-700">
        <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
            <a href="{% url 'profile' %}" class="text-indigo-400 hover:underline">‚Üê Back to Profile</a>
            <h1 class="text-lg font-semibold">Chat with {{ friend.username }}</h1>
            <div class="w-20"></div>
        </div>
    </header>

    <!-- Messages -->
    <main class="flex-1 overflow-y-auto pt-20 pb-28" id="chat-messages">
        <div class="max-w-4xl mx-auto p-4 space-y-3">
            {% for message in chat_messages %}
                <div class="flex {% if message.sender == request.user %}justify-end{% endif %}">
                    <div class="rounded-2xl px-4 py-2 max-w-[72%] shadow glass border border-gray-700
                                            {% if message.sender == request.user %} ring-1 ring-emerald-600/40 {% endif %}">
                        <p class="text-sm">{{ message.content }}</p>
                        <p class="text-[10px] text-gray-400 mt-1">{{ message.created_at|date:"g:i A" }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>
    </main>

    <!-- Composer -->
    <footer class="fixed bottom-0 w-full glass border-t border-gray-700">
        <form id="message-form" class="max-w-4xl mx-auto p-4 flex gap-2">
            {% csrf_token %}
            <input id="message-input" type="text" placeholder="Type your message..."
                         class="flex-1 rounded-xl bg-[#0f1216] border border-gray-700 px-4 py-3 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"/>
            <button class="btn btn-purple px-6 py-3 transition-transform">Send</button>
        </form>
    </footer>

    <script>
        const messageForm=document.getElementById('message-form');
        const messageInput=document.getElementById('message-input');
        const messagesContainer=document.getElementById('chat-messages');
        let lastMessageTime='{{ chat_messages.last.created_at|date:"Y-m-d H:i:s" }}';
        messagesContainer.scrollTop=messagesContainer.scrollHeight;

        messageForm.addEventListener('submit',async(e)=>{
            e.preventDefault();
            const content=messageInput.value.trim();
            if(!content) return;
            try{
                const res=await fetch('{% url "send_message" friend.username %}',{
                    method:'POST',
                    headers:{'X-CSRFToken':'{{ csrf_token }}'},
                    body:new FormData(messageForm)
                });
                if(res.ok){ messageInput.value=''; await fetchNewMessages(); }
            }catch(err){ console.error(err); }
        });

        async function fetchNewMessages(){
            try{
                const res=await fetch(`{% url "get_messages" friend.username %}?after=${lastMessageTime}`);
                const data=await res.json();
                data.messages.forEach(m=>{
                    const el=document.createElement('div');
                    el.className=`mb-3 flex ${m.sender==='{{ request.user.username }}'?'justify-end':''}`;
                    el.innerHTML=`
                        <div class="rounded-2xl px-4 py-2 max-w-[72%] shadow glass border border-gray-700 ${m.sender==='{{ request.user.username }}'?'ring-1 ring-emerald-600/40':''}">
                            <p class="text-sm">${m.content}</p>
                            <p class="text-[10px] text-gray-400 mt-1">${new Date(m.created_at).toLocaleTimeString()}</p>
                        </div>`;
                    messagesContainer.querySelector('.max-w-4xl').appendChild(el);
                });
                if(data.messages.length){ lastMessageTime=data.messages.at(-1).created_at; messagesContainer.scrollTop=messagesContainer.scrollHeight; }
            }catch(err){ console.error(err); }
        }
        setInterval(fetchNewMessages,3000);
    </script>
</body>
</html>