{% extends 'base.html' %}

{% block content %}
<div class="max-w-3xl mx-auto py-12">
  <h2 class="text-3xl font-semibold text-center mb-6">Discover People</h2>

  <div id="card" class="bg-gray-900 rounded-lg p-6 shadow-md max-w-xl mx-auto text-center relative overflow-hidden">
    <div id="no-more" class="hidden p-8">
      <p class="text-gray-400">No more people to show right now.</p>
    </div>

    <div id="profile" class="space-y-4 transform transition-transform duration-300 ease-out">
      <div id="card-inner" class="bg-gray-800 rounded-lg p-6 flex flex-col items-center gap-4">
          <img id="artist-image" src="" alt="Artist" class="w-48 h-48 rounded-md object-cover shadow-md hidden">
          <h3 id="username" class="text-2xl font-semibold"></h3>
          <div id="compatibility" class="text-gray-400"></div>

          <div id="bio-container" class="max-w-prose text-sm text-gray-300">
            <p id="bio"></p>
          </div>

          <div>
            <h4 class="font-semibold">Top Artists</h4>
            <ul id="top-artists" class="text-sm text-gray-300 list-disc list-inside"></ul>
          </div>

          <div id="genres-container" class="w-full">
            <h4 class="font-semibold">Top Genres</h4>
            <p id="genres" class="text-sm text-gray-300"></p>
          </div>

          <div id="tracks-container" class="w-full">
            <h4 class="font-semibold">Top Tracks</h4>
            <ul id="top-tracks" class="text-sm text-gray-300 list-disc list-inside"></ul>
          </div>
        </div>

      <div class="flex gap-4 justify-center mt-4">
        <button id="dislike" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded">Dislike</button>
        <button id="like" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded">Like</button>
      </div>
      <div id="spinner" class="hidden mt-4 text-gray-400">Loading…</div>
    </div>
  </div>
</div>

<script>
// Helpers
function getCookie(name) {
  const v = `; ${document.cookie}`;
  const parts = v.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

const CSRF_TOKEN = getCookie('csrftoken');

async function fetchNext() {
  try {
    // show loading
    document.getElementById('spinner').classList.remove('hidden');
    const res = await fetch('/api/swipe/next', { credentials: 'same-origin' });
    if (!res.ok) {
      console.error('fetchNext: bad response', res.status);
      document.getElementById('spinner').classList.add('hidden');
      return null;
    }
    const data = await res.json();
  const profileEl = document.getElementById('profile');
  if (!data.user) {
    profileEl.style.display = 'none';
    document.getElementById('no-more').classList.remove('hidden');
    document.getElementById('spinner').classList.add('hidden');
    return null;
  }
  profileEl.style.display = 'block';
  document.getElementById('no-more').classList.add('hidden');
  document.getElementById('username').textContent = data.user.username;
  // artist image (use first top artist image if present)
  const artistImage = document.getElementById('artist-image');
  if (data.top_artists && data.top_artists.length && data.top_artists[0].image) {
    artistImage.src = data.top_artists[0].image;
    artistImage.classList.remove('hidden');
  } else {
    artistImage.classList.add('hidden');
  }
  if (data.compatibility) {
    document.getElementById('compatibility').textContent = `Compatibility: ${data.compatibility.total_score}%`;
    // show breakdown if present
    if (data.compatibility.breakdown) {
      const bd = data.compatibility.breakdown;
      document.getElementById('compatibility').textContent += ` (Artists ${bd.artist_compatibility}% • Genres ${bd.genre_compatibility}% • Tracks ${bd.track_compatibility}%)`;
    }
  } else {
    document.getElementById('compatibility').textContent = 'Compatibility: N/A';
  }
  const artistsList = document.getElementById('top-artists');
  artistsList.innerHTML = '';
  data.top_artists.forEach(a => {
    const li = document.createElement('li');
    li.textContent = a.name;
    artistsList.appendChild(li);
  });

  // bio
  const bioEl = document.getElementById('bio');
  if (data.user.bio) {
    bioEl.textContent = data.user.bio;
    document.getElementById('bio-container').classList.remove('hidden');
  } else {
    bioEl.textContent = '';
    document.getElementById('bio-container').classList.add('hidden');
  }

  // genres
  const genresEl = document.getElementById('genres');
  if (data.genres && data.genres.length) {
    genresEl.textContent = data.genres.join(', ');
    document.getElementById('genres-container').classList.remove('hidden');
  } else {
    genresEl.textContent = '';
    document.getElementById('genres-container').classList.add('hidden');
  }

  // top tracks
  const tracksList = document.getElementById('top-tracks');
  tracksList.innerHTML = '';
  if (data.top_tracks && data.top_tracks.length) {
    data.top_tracks.forEach(t => {
      const li = document.createElement('li');
      li.textContent = `${t.name} — ${t.artists.join(', ')}`;
      tracksList.appendChild(li);
    });
    document.getElementById('tracks-container').classList.remove('hidden');
  } else {
    document.getElementById('tracks-container').classList.add('hidden');
  }

  // reset transform
  const card = document.getElementById('card-inner');
  card.style.transform = '';
  card.style.transition = '';
  document.getElementById('spinner').classList.add('hidden');
  // enable buttons when we have a candidate
  setButtonsEnabled(true);
  return data.user.username;
  } catch (err) {
    console.error('fetchNext error', err);
    // hide spinner and disable actions on error
    document.getElementById('spinner').classList.add('hidden');
    setButtonsEnabled(false);
    return null;
  }
}

async function sendAction(username, action) {
  try {
    const res = await fetch('/api/swipe/action', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN},
      body: JSON.stringify({other_username: username, action: action})
    });
    if (!res.ok) {
      console.error('sendAction failed', res.status);
      return null;
    }
    return await res.json();
  } catch (err) {
    console.error('sendAction error', err);
    return null;
  }
}

let currentUsername = null;
let isDragging = false;
let startX = 0;
let currentX = 0;

const cardInner = document.getElementById('card-inner');

cardInner.addEventListener('pointerdown', (e) => {
  isDragging = true;
  startX = e.clientX;
  cardInner.setPointerCapture(e.pointerId);
});

cardInner.addEventListener('pointermove', (e) => {
  if (!isDragging) return;
  currentX = e.clientX - startX;
  cardInner.style.transform = `translateX(${currentX}px) rotate(${currentX/20}deg)`;
});

cardInner.addEventListener('pointerup', async (e) => {
  isDragging = false;
  const threshold = 120;
  if (currentX > threshold) {
    // like
    cardInner.style.transition = 'transform 300ms ease-out';
    cardInner.style.transform = `translateX(1000px) rotate(30deg)`;
    await sendAction(currentUsername, 'like');
    currentUsername = await fetchNext();
  } else if (currentX < -threshold) {
    // dislike
    cardInner.style.transition = 'transform 300ms ease-out';
    cardInner.style.transform = `translateX(-1000px) rotate(-30deg)`;
    await sendAction(currentUsername, 'dislike');
    currentUsername = await fetchNext();
  } else {
    // snap back
    cardInner.style.transition = 'transform 200ms ease-out';
    cardInner.style.transform = '';
  }
  currentX = 0;
});

// Keyboard support: left = dislike, right = like
document.addEventListener('keydown', async (e) => {
  if (!currentUsername) return;
  if (e.key === 'ArrowRight') {
    cardInner.style.transition = 'transform 300ms ease-out';
    cardInner.style.transform = `translateX(1000px) rotate(30deg)`;
    await sendAction(currentUsername, 'like');
    currentUsername = await fetchNext();
  } else if (e.key === 'ArrowLeft') {
    cardInner.style.transition = 'transform 300ms ease-out';
    cardInner.style.transform = `translateX(-1000px) rotate(-30deg)`;
    await sendAction(currentUsername, 'dislike');
    currentUsername = await fetchNext();
  }
});

// Buttons fallback
document.getElementById('like').addEventListener('click', async () => {
  if (!currentUsername) return;
  // animate
  cardInner.style.transition = 'transform 300ms ease-out';
  cardInner.style.transform = `translateX(1000px) rotate(30deg)`;
  await sendAction(currentUsername, 'like');
  currentUsername = await fetchNext();
});

document.getElementById('dislike').addEventListener('click', async () => {
  if (!currentUsername) return;
  cardInner.style.transition = 'transform 300ms ease-out';
  cardInner.style.transform = `translateX(-1000px) rotate(-30deg)`;
  await sendAction(currentUsername, 'dislike');
  currentUsername = await fetchNext();
});

function setButtonsEnabled(enabled) {
  const like = document.getElementById('like');
  const dislike = document.getElementById('dislike');
  if (enabled) {
    like.removeAttribute('disabled');
    dislike.removeAttribute('disabled');
    like.classList.remove('opacity-50', 'cursor-not-allowed');
    dislike.classList.remove('opacity-50', 'cursor-not-allowed');
  } else {
    like.setAttribute('disabled', 'disabled');
    dislike.setAttribute('disabled', 'disabled');
    like.classList.add('opacity-50', 'cursor-not-allowed');
    dislike.classList.add('opacity-50', 'cursor-not-allowed');
  }
}

// Init
init = async () => { currentUsername = await fetchNext(); };
init();
// disable buttons initially until first candidate loaded
setButtonsEnabled(false);
</script>

{% endblock %}
