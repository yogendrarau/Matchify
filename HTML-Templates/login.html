<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Login - Matchify</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .message-popup {
                    background-color: #f87171; /* red */
                    color: white;
                    padding: 10px 14px;
                    border-radius: 8px;
                    box-shadow: 0 6px 20px rgba(2,6,23,0.6);
            }
            .fade-up { animation: fadeUp 600ms ease both; }
            @keyframes fadeUp { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0);} }
        </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-black via-[#0c0c0c] to-[#121212] flex items-center justify-center text-white px-4">
    <div class="w-full max-w-md">
        <div class="text-center mb-6 fade-up">
            <h1 class="text-5xl font-extrabold bg-gradient-to-r from-green-400 to-emerald-600 bg-clip-text text-transparent drop-shadow">Matchify</h1>
            <p class="text-gray-400 mt-1">Welcome back — let’s vibe.</p>
        </div>

        <div class="bg-[#1a1d21]/70 border border-gray-700 backdrop-blur-md rounded-2xl shadow-xl overflow-hidden fade-up">
            <div class="p-6">
                <!-- Messages -->
                <div id="messages" class="space-y-2 mb-3"></div>

                <form id="loginForm" method="POST" class="space-y-4">
                    {% csrf_token %}

                    <div>
                        <label for="username" class="block text-sm text-gray-300 mb-1">Username or Email</label>
                        <input id="username" name="username" type="text" placeholder="you@music.com"
                            class="w-full rounded-xl bg-[#0f1216] border border-gray-700 px-4 py-3 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent shadow-inner" />
                    </div>

                    <div>
                        <label for="password" class="block text-sm text-gray-300 mb-1">Password</label>
                        <input id="password" name="password" type="password" placeholder="••••••••"
                            class="w-full rounded-xl bg-[#0f1216] border border-gray-700 px-4 py-3 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent shadow-inner" />
                    </div>

                    <div id="captcha-slot">
                        {{ form.captcha }}
                    </div>

                    <button type="submit" class="w-full py-5 rounded-xl text-base font-semibold bg-gradient-to-r from-green-400 to-emerald-600 hover:scale-[1.02] transition-transform shadow-md">Login</button>
                </form>

                <div class="flex items-center justify-between mt-4 text-sm">
                    <a href="{% url 'password_reset' %}" class="text-indigo-400 hover:underline">Forgot password?</a>
                    <a href="{% url 'register' %}" class="text-fuchsia-400 hover:underline">Create account</a>
                </div>

                <div class="flex items-center gap-4 my-6">
                    <div class="flex-1 h-px bg-gray-700"></div>
                    <span class="text-gray-400 text-xs">or</span>
                    <div class="flex-1 h-px bg-gray-700"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Attach AJAX submit similar to previous implementation
        document.getElementById('loginForm').addEventListener('submit', function (event) {
            event.preventDefault();
            var form = event.target;
            var formData = new FormData(form);
            var submitButton = form.querySelector('button[type="submit"]');
            var messagesDiv = document.getElementById('messages');

            submitButton.disabled = true;
            submitButton.innerHTML = 'Logging in...';

            // Helper to read a cookie by name (used for CSRF fallback)
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            // Prefer the form CSRF token, but fall back to the csrftoken cookie (more robust across browsers)
            const csrfFromForm = (form.querySelector('[name=csrfmiddlewaretoken]') || {}).value;
            const csrfToken = csrfFromForm || getCookie('csrftoken');

            fetch(form.action || window.location.pathname, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                },
            })
            .then(async response => {
                // If server returned non-OK status, try to parse JSON error, else throw
                let payload = null;
                try {
                    payload = await response.clone().json();
                } catch (e) {
                    // Non-JSON response
                    payload = null;
                }

                if (!response.ok) {
                    const msg = (payload && payload.messages && payload.messages[0]) || 'An unexpected error occurred. Please try again.';
                    throw new Error(msg);
                }

                return payload;
            })
            .then(data => {
                messagesDiv.innerHTML = '';
                if (data && data.success) {
                    window.location.href = data.redirect_url || '/';
                } else if (data) {
                    if (data.messages) {
                        data.messages.forEach(message => {
                            var messageEl = document.createElement('div');
                            messageEl.className = 'message-popup';
                            messageEl.innerHTML = `<span>${message}</span> <button onclick="this.parentElement.remove();">&times;</button>`;
                            messagesDiv.appendChild(messageEl);
                        });
                    }
                    if (data.reset_captcha && typeof grecaptcha !== 'undefined') grecaptcha.reset();
                } else {
                    messagesDiv.innerHTML = '<div class="message-popup">An unexpected error occurred. Please try again.</div>';
                }
            })
            .catch(err => {
                messagesDiv.innerHTML = `<div class="message-popup">${err.message || 'An unexpected error occurred. Please try again.'}</div>`;
                console.error('Login error', err);
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Login';
            });
        });
    </script>
</body>

</html>